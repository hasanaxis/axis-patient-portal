generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ===== SIMPLE MODELS FOR DEVELOPMENT =====

model User {
  id          String   @id @default(cuid())
  email       String?  @unique
  firstName   String
  lastName    String
  phoneNumber String   @unique
  passwordHash String?
  isVerified  Boolean  @default(false)
  role        String   @default("PATIENT") // PATIENT, ADMIN, STAFF
  
  // 2FA Settings
  twoFactorEnabled Boolean @default(false)
  twoFactorMethod  String? // SMS, AUTHENTICATOR_APP
  twoFactorSecret  String?
  
  // Registration tracking
  invitedAt       DateTime?
  registeredAt    DateTime?
  lastLoginAt     DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  patient     Patient?
  sessions    Session[]
  verificationCodes VerificationCode[]
  invitations PatientInvitation[]
}

model Patient {
  id             String   @id @default(cuid())
  userId         String   @unique
  patientNumber  String   @unique
  dateOfBirth    DateTime
  gender         String?
  medicareNumber String?
  ihi            String?
  
  // Address
  streetAddress  String?
  suburb         String?
  state          String?
  postcode       String?
  country        String   @default("Australia")
  
  // Medical info (simplified for SQLite)
  allergies      String?  // JSON string
  medications    String?  // JSON string
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  user           User     @relation(fields: [userId], references: [id])
  studies        Study[]
}

model Study {
  id                String   @id @default(cuid())
  patientId         String
  studyInstanceUID  String   @unique
  accessionNumber   String   @unique
  studyDate         DateTime
  studyDescription  String
  modality          String   // XR, CT, MRI, US
  bodyPartExamined  String
  status            String   @default("COMPLETED") // SCHEDULED, IN_PROGRESS, COMPLETED
  priority          String   @default("ROUTINE") // ROUTINE, URGENT, STAT
  
  // Additional info
  referringPhysician String?
  performingPhysician String?
  institutionName    String?
  numberOfSeries     Int     @default(1)
  numberOfInstances  Int     @default(1)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  patient           Patient  @relation(fields: [patientId], references: [id])
  report            Report?
  series            Series[]
}

model Series {
  id               String  @id @default(cuid())
  studyId          String
  seriesInstanceUID String @unique
  seriesNumber     Int
  seriesDescription String?
  modality         String
  numberOfInstances Int    @default(1)
  
  createdAt        DateTime @default(now())
  
  // Relations
  study            Study    @relation(fields: [studyId], references: [id])
  images           Image[]
}

model Image {
  id               String @id @default(cuid())
  seriesId         String
  sopInstanceUID   String @unique
  instanceNumber   Int
  imageUrl         String
  thumbnailUrl     String?
  
  createdAt        DateTime @default(now())
  
  // Relations
  series           Series   @relation(fields: [seriesId], references: [id])
}

model Report {
  id              String   @id @default(cuid())
  studyId         String   @unique
  reportNumber    String   @unique
  radiologistId   String?
  
  // Report content
  clinicalHistory String?
  technique       String?
  findings        String
  impression      String
  recommendations String?
  
  priority        String   @default("ROUTINE")
  status          String   @default("DRAFT") // DRAFT, PRELIMINARY, FINAL
  isCritical      Boolean  @default(false)
  
  // Timestamps
  dictatedAt      DateTime?
  verifiedAt      DateTime?
  approvedAt      DateTime?
  sentToReferrerAt DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  study           Study    @relation(fields: [studyId], references: [id])
}

model Session {
  id           String    @id @default(cuid())
  userId       String
  token        String    @unique
  refreshToken String?   @unique
  expiresAt    DateTime
  isActive     Boolean   @default(true)
  ipAddress    String?
  userAgent    String?
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  // Relations
  user         User      @relation(fields: [userId], references: [id])
}

// Verification codes for SMS/Email OTP
model VerificationCode {
  id          String   @id @default(cuid())
  userId      String?
  phoneNumber String?
  email       String?
  code        String
  type        String   // REGISTRATION, LOGIN, PASSWORD_RESET, TWO_FACTOR
  attempts    Int      @default(0)
  maxAttempts Int      @default(3)
  isUsed      Boolean  @default(false)
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  
  // Relations
  user        User?    @relation(fields: [userId], references: [id])
  
  @@index([phoneNumber, code])
  @@index([email, code])
}

// Patient invitations from RIS
model PatientInvitation {
  id                String   @id @default(cuid())
  patientNumber     String   @unique
  phoneNumber       String
  dateOfBirth       DateTime
  firstName         String
  lastName          String
  studyAccessionNumber String?
  risMessageId      String?  @unique
  
  // Invitation tracking
  invitationToken   String   @unique
  invitationUrl     String
  smsSentAt         DateTime?
  smsDeliveredAt    DateTime?
  clickedAt         DateTime?
  registeredAt      DateTime?
  
  // Status
  status            String   @default("PENDING") // PENDING, SMS_SENT, CLICKED, REGISTERED, EXPIRED
  expiresAt         DateTime
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  userId            String?
  user              User?    @relation(fields: [userId], references: [id])
  
  @@index([phoneNumber, dateOfBirth])
  @@index([invitationToken])
}